---
title: L3HCTF 2021 MISC bootflag
categories:
- BIOS
tags: 
---

> 更新中...破解新版本AMI的BIOS密码，其实就是一个SHA256。

- 给了一个视频和一个flashdump的固件
- [W25Q256JVFIQ.bin](https://xuanxuanblingbling.github.io/assets/attachment/l3hctf/W25Q256JVFIQ.bin) 这个flashdump就是bios的存储实体
- 视频是在bios里设置两个密码，flag就是这两个密码，视频关键截图如下

![image](https://xuanxuanblingbling.github.io/assets/pic/l3hctf/bios.png)

## BIOS介绍

从截图中可看出，这是一个能管理BIOS的Web界面，显然在BIOS阶段，主系统并不能工作，那这个东西是如何实现的呢？这个左上角的KVM又是啥呢？

- [如何看待英特尔管理引擎(Intel ME)被爆出运行在 Minix3 操作系统？ - 老狼的回答 - 知乎 ](https://www.zhihu.com/question/67749141/answer/258836782)
- [为什么很多用了几十年的主板也没听说过BIOS的数据坏了的呢？BIOS存储在哪里？](https://zhuanlan.zhihu.com/p/137947510)
- [输错BIOS密码，电脑被锁怎么办？](https://zhuanlan.zhihu.com/p/44503341)
- [如今电脑的 BIOS 密码要怎么消除？](https://www.zhihu.com/question/24963009/answer/556873968)

其实小的时候他听说也只是听说拔电池...

## 基本方法

根据视频可以发现这个bios的名字叫：aptio setup utility，但是搜这玩意搜不到啥，根据其厂商American Megatrends Incorporated 搜索AMI bios就有一些文章了：

- [破解「清华同方 超越 S100」的 BIOS 密码限制](https://blog.hackpascal.net/2018/03/crack-bios-password-limitation-of-tsinghua-tongfang-chaoyue-s100/)

MMTOOL可以看到一个L3HSecDxe，也可以提取出PE文件，解压出来是个去掉开头0x44字节是个PE，但其路径是bootflag2，所以看起来跟第一关关系不大。

- [COMS密码破解工具下载](http://www.biosrepair.com/jb/bios1.htm)但是不会用，不知道姿势，感觉这些工具好像都是在破本机的bios，


## 模拟运行

所以两个办法，逆向或者调试。逆向就是上图软件的实现，调试我知道qemu能直接给bios格式启动



- [Run BIOS at QEMU](https://www.bios-mods.com/forum/Thread-Run-BIOS-at-QEMU)

但是此文件是spi flash 的 dump，搜索发现，qemu也是可以直接给flash的：

- [不需要硬件也可以开发UEFI](https://zhuanlan.zhihu.com/p/107360611)

```
➜  qemu-system-x86_64 -pflash ./W25Q256JVFIQ.bin
WARNING: Image format was not specified for './W25Q256JVFIQ.bin' and probing guessed raw.
         Automatically detecting the format is dangerous for raw images, write operations on block 0 will be restricted.
         Specify the 'raw' format explicitly to remove the restrictions.
qemu-system-x86_64: combined size of system firmware exceeds 8388608 bytes
```

但此dump是32M，qemu最大限制是8M：

看起来又得patch qemu，patch完了，

```
hw/i386/pc_sysfw.c

#define FLASH_SIZE_LIMIT (8 * MiB)
```


[PATCH: Increase System Firmware Max Size](https://lists.gnu.org/archive/html/qemu-devel/2020-09/msg05504.html)

但是执行没有显示界面，gdb挂上发现的确运行了....

所以他可能是个真机的bios，qemu不支持其硬件设备，无法模拟....

他视频里那个玩意好像是个什么kvm管理器，不知道人家是咋运行的，或者就是个真机...

如果能运行起来可能能本地爆破，因为两个密码都是1679616种可能，是2^20是可以爆破的。
能运行或者能本地调试结合逆向和以前的文章在内存中看出什么...

## 继续逆向

- [https://github.com/LongSoft/UEFITool](https://github.com/LongSoft/UEFITool/)

搜索“Confirm New”找到目标模块：AMITSE，对这个PE逆向，没啥结果

![image](https://xuanxuanblingbling.github.io/assets/pic/l3hctf/pe.png)

## 柳暗花明

突然想明白，对这个代码逆向没有直接的意义，因为密码是要存在数据区的，平时elf是在内存，配置可能落地为文件系统中的文件，对于bios固件，用户写入的数据在呢？uefitool发现这玩意有nvram区，之前l1n3师傅教过我，nvram就是划分的一段flash存储，用于持久化存储用户配置，故搜索AMI、nvram、password、AMITSE等关键字，可以搜到：

[Recovering the BIOS password from a Panasonic CF-U1 mk2 (AMI Aptio UEFI)](https://gist.github.com/en4rab/550880c099b5194fbbf3039e3c8ab6fd)

密码在果然在nvram区，并且其uuid是固定的：

C811FA38-42C8-4579-A9BB-60E94EDDFB34 (AMITSESetup)

![image](https://xuanxuanblingbling.github.io/assets/pic/l3hctf/hash.png)

但数据显然与此文不同，异或无效，开始还以为魔改了异或的魔数，后来在提出的PE里找异或指令都没找到，感觉不对：

```
55850E9EEF1708206617B07FA1C3D5D0
C44C3EF74D7AB02EB22FC64A18E90BE9
0000000000000000873EEAC1D84A1734
53A2486CC556764F12D4B2A85885E819
325239B3AE3EF0770000000000000000
01
```

翻评论说升级hash了，一顿搜索，找到twitter：
https://twitter.com/dev_console/status/1345851717389266944


- [hashcat破解密码规则示例](https://blog.csdn.net/robinfoxnan/article/details/113625559)
- [Hashcat的使用手册总结](https://xz.aliyun.com/t/4008)
- [Hashcat 学习记录](https://www.sqlsec.com/2019/10/hashcat.html)

```
➜  hashcat -m 1430 -a 3 -w 3 -O --hex-salt 55850E9EEF1708206617B07FA1C3D5D0C44C3EF74D7AB02EB22FC64A18E90BE9:0000000000000000000000000000000000000000000000000000000000000000 "?a?a?a?a" --show
55850e9eef1708206617b07fa1c3d5d0c44c3ef74d7ab02eb22fc64a18e90be9:0000000000000000000000000000000000000000000000000000000000000000:7K62
➜  hashcat -m 1430 -a 3 -w 3 -O --hex-salt 873EEAC1D84A173453A2486CC556764F12D4B2A85885E819325239B3AE3EF077:0000000000000000000000000000000000000000000000000000000000000000 "?a?a?a?a" --show
873eeac1d84a173453a2486cc556764f12d4b2a85885e819325239b3ae3ef077:0000000000000000000000000000000000000000000000000000000000000000:7D12

//L3HCTF{7D127k62} // 不知道为啥K出来的是大写（可能密码里，K本来就是大写，flag计划错了）
```

## 其他WP

- [L3HCTF 2021 Official Write Up](https://hust-l3hsec.feishu.cn/docs/doccniAzQvQixcSUF5f4tXMLHdc#A9xQUJ)
- [2021-L3HCTF(我愿称其为今年国内最好CTF好伐！！！) SpecialRain-Writeup](http://xibai.xyz/2021/11/15/2021-L3HCTF/)
- [Nepnep L3HCTF 2021 WP 密码：9f91f8](https://share.weiyun.com/qpI3UMnk)